#!/usr/bin/env ruby
require 'optparse'
require 'specjour'

options = {:worker_size => 1, :batch_size => 1}

optparse = OptionParser.new do |opts|
  opts.banner = "Usage: specjour [options]"

  opts.on('-w', '--workers [WORKERS]', Numeric, "Number of WORKERS to spin up, defaults to #{options[:worker_size]}") do |n|
    options[:worker_size] = n
  end

  opts.on('-b', '--batch-size [SIZE]', Integer, "Number of specs to run before reporting back to the dispatcher, defaults to #{options[:batch_size]}") do |n|
    options[:batch_size] = n
  end

  opts.on('-d', '--dispatcher HOSTNAME', "Only run specs from the dispatcher running on this host, i.e. farnsworth.local") do |name|
    options[:registered_dispatcher] = name
  end

  opts.on('--do-work OPTIONS', Array, 'INTERNAL USE ONLY') do |args|
    specs_to_run = args[3..-1]
    options[:worker_args] = args[0], args[1], args[2], specs_to_run
  end

  opts.on_tail('-v', '--version', 'Show the version of specjour') do
    abort Specjour::VERSION
  end

  opts.on_tail("-h", "--help", "Show this message") do
    summary = opts.to_a
    summary.first << "\n"
    abort summary.reject {|s| s =~ /INTERNAL/}.join
  end
end

optparse.parse!

if options[:worker_args]
  options[:worker_args] << options[:batch_size]
  Specjour::Worker.new(*options[:worker_args]).run
else
  Specjour::Manager.new(options).start
end
